{"componentChunkName":"component---src-templates-post-post-jsx","path":"/blog/20200630","result":{"data":{"markdownRemark":{"html":"<p><a href=\"https://hackmd.io/AiLYT8n8TRq5H8ln52b27g?view\" target=\"_blank\" rel=\"nofollow\">HackMD</a></p>\n<p>ç°¡ä»‹ Express RESTful API Server ç¯„ä¾‹ä¸­ (ä½¿ç”¨ MongoDB ODM Mongoose)</p>\n<ul>\n<li>åˆ©ç”¨ JWT åšé©—è­‰ (Authentication)</li>\n<li>åˆ©ç”¨è‡ªå·±å®šç¾©çš„ User roles å’Œ permissions åšæˆæ¬Š (Authorization)</li>\n<li>åˆ©ç”¨ä¸€äº›ç¾è¡Œå¯é˜²æ­¢å¸¸è¦‹çš„å®‰å…¨æ€§å•é¡Œçš„ middlewareã€å¯†ç¢¼åšè™•ç† (Security)</li>\n</ul>\n<p><a href=\"https://gitlab.baifu-tech.net/f2e_tw/hr-api-server\" target=\"_blank\" rel=\"nofollow\">ğŸ‘‰ GitLab Clone</a></p>\n<h2><a href=\"https://jwt.io/\" target=\"_blank\" rel=\"nofollow\">JSON Web Token (JWT)</a> ç°¡ä»‹</h2>\n<blockquote>\n<p>æœ‰é™æ™‚é–“å…§å¯åˆ©ç”¨èªè­‰ä»¤ç‰Œè¦æ±‚å°æ‡‰çš„ API æ“ä½œæ¬Šé™</p>\n</blockquote>\n<ul>\n<li>åŸºæ–¼ JSON Object çš„é–‹æ”¾æ¨™æº–å”è­° <a href=\"https://tools.ietf.org/html/rfc7519\" target=\"_blank\" rel=\"nofollow\">RFC 7519</a></li>\n<li>\n<p>é©ç”¨æ–¼æˆæ¬Šå’Œè¨Šæ¯äº¤æ›</p>\n<ul>\n<li>å–®ä¸€ç™»éŒ„ (Single Sign On) æ˜¯ç•¶ä»Šå»£æ³›ä½¿ç”¨ JWT çš„åŠŸèƒ½ä¹‹ä¸€ï¼Œæˆæœ¬è¼ƒå°ä¸”å¯ä»¥åœ¨ä¸åŒçš„ domain ä¸­è¼•é¬†ä½¿ç”¨</li>\n</ul>\n</li>\n<li>\n<p>ç¬¦åˆ Stateless ç„¡ç‹€æ…‹ (payload ä¸­ç›´æ¥çµ¦ Server éœ€è¦çš„å€¼ï¼ŒJWT æ‡‰èƒ½è¡¨æ˜èº«ä»½)</p>\n<ul>\n<li>æ˜“æ°´å¹³æ“´å±•ï¼Œé©ç”¨æ–¼è·¨ä¼ºæœå™¨ã€è·¨åŸŸçš„è«‹æ±‚</li>\n</ul>\n</li>\n<li>\n<p>Token æ‡‰åªèƒ½åœ¨ Server ç«¯è¢«é©—è­‰ï¼Œä¸¦ <strong>store JWT in HTTPOnly cookies</strong></p>\n<ul>\n<li>Cookie åªé™è¢«ä¼ºæœç«¯å­˜å–ï¼Œç„¡æ³•åœ¨ç”¨æˆ¶ç«¯è®€å–</li>\n<li>æŠµç¦¦æ”»æ“Šè€…åˆ©ç”¨ Cross-Site Scripting (XSS) æ‰‹æ³•ä¾†ç›œå–ç”¨æˆ¶èº«ä»½ï¼Œä¾‹å¦‚ <code>document.cookie</code> å–å¾— cookies</li>\n<li>Chrome æœ‰åƒ <a href=\"https://chrome.google.com/webstore/detail/editthiscookie/fngmhnnpilhplaeedifhccceomclgfbg\" target=\"_blank\" rel=\"nofollow\">EditThisCookie</a> çš„æŸ¥çœ‹/ä¿®æ”¹ Cookie å·¥å…·</li>\n</ul>\n</li>\n<li>é©ç”¨æ–¼ç„¡é—œå®‰å…¨è­°é¡Œçš„æ“ä½œæ¬Šé™æˆèˆ‡</li>\n<li>\n<p>ç„¡æ³•å–ä»£ Cookies æˆ– Sessionï¼Œåªæ˜¯ä¸€ç¨®æ–°çš„æ“ä½œæ¬Šé™çš„æˆèˆ‡æ–¹æ³•</p>\n<ul>\n<li>Sessionã€Cookieã€JWT æ˜¯å¯ä»¥ä¸€èµ·ä½¿ç”¨çš„</li>\n</ul>\n</li>\n<li>å¯ä»¥åšç‚ºå¯¦ç¾ <strong>OAuth 2.0 æˆæ¬Šæ¡†æ¶è¦ç¯„</strong> <a href=\"https://tools.ietf.org/html/rfc6749\" target=\"_blank\" rel=\"nofollow\">RFC 6749</a> ä¸­çš„ä¸€ç¨®èªè­‰æ©Ÿåˆ¶ä½¿ç”¨</li>\n</ul>\n<h3>JWT çµ„æˆ (é€™é‚Šéƒ½æŒ‡ JWS Compact Serialization)</h3>\n<blockquote>\n<p><a href=\"https://tools.ietf.org/html/rfc7515\" target=\"_blank\" rel=\"nofollow\">JWS(JSON Web Signature)</a> å’Œ <a href=\"https://tools.ietf.org/html/rfc7516\" target=\"_blank\" rel=\"nofollow\">JWE(JSON Web Encryption)</a> æ˜¯ JWT çš„å¯¦ä½œæ–¹å¼ï¼Œé€™é‚Šç°¡ä»‹å’Œå¯¦ä½œç¯„ä¾‹éƒ½æ˜¯ JWS (Compact Serialization)ï¼šå°ã€è‡ªåŒ…å«ã€æœ€ç°¡æ˜“ ğŸ‘»</p>\n</blockquote>\n<p><img src=\"https://i.imgur.com/8ny9Nla.png\"><br>\n<img src=\"https://i.imgur.com/MbEmWgj.png\"><br>\nJWT ç”± headerã€payloadã€signature ä¸‰å€‹éƒ¨åˆ†å„è‡ª base64 ç·¨ç¢¼è™•ç†å¾Œçµ„æˆ</p>\n<ul>\n<li>\n<p>headerï¼šä¼ºæœå™¨å¦‚ä½•åŠ è§£å¯†çš„ä¾æ“š</p>\n<deckgo-highlight-code json  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">{\n&quot;alg&quot;: &quot;HS256&quot;, // ALGORITHM: required\n&quot;typ&quot;: &quot;JWT&quot; // TOKEN TYPE: optional\n}</code>\n        </deckgo-highlight-code>\n</li>\n<li>\n<p>payload (claims)ï¼šæ”¾èªè­‰éœ€è¦çš„è²æ˜å…§å®¹</p>\n<deckgo-highlight-code json  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">{\n&quot;sub&quot;: &quot;1234567890&quot;,\n&quot;name&quot;: &quot;John Doe&quot;,\n&quot;iat&quot;: 1516239022\n}</code>\n        </deckgo-highlight-code>\n<ul>\n<li>Reserved (è¨»å†Šè²æ˜) - å»ºè­°ä½†ä¸å¼·åˆ¶ä½¿ç”¨</li>\n<li>iss (issuer)ï¼šç™¼è¡Œäºº</li>\n<li>sub (subject)ï¼šä¸»é¡Œ (ç”¨æˆ¶)</li>\n<li>\n<p>aud (audience)ï¼šç›®æ¨™æ”¶ä»¶äºº</p>\n<ul>\n<li>é€šå¸¸ç‚º URI æ¸…å–®ï¼Œè¡¨ç¤ºæ­¤ JWT å¯å­˜å–è©²æ¸…å–®ä¸­çš„è³‡æº (ä½å€)</li>\n</ul>\n</li>\n<li>exp (expiration time)ï¼šåˆ°æœŸçš„æ™‚é–“</li>\n<li>nbf (not before time)ï¼šé–‹å§‹æœ‰æ•ˆçš„æ™‚é–“</li>\n<li>iat (issued at time)ï¼šç™¼å¸ƒæ™‚é–“</li>\n<li>jti (JWT ID)</li>\n<li>Public (å…¬é–‹è²æ˜) - <a href=\"https://www.iana.org/assignments/jwt/jwt.xhtml#claims\" target=\"_blank\" rel=\"nofollow\">IANA JSON Web Token</a> è²æ˜è¨»å†Šè¡¨ä¸Šè¨»å†Šçš„è²æ˜</li>\n<li>Private (ç§æœ‰è²æ˜) - è‡ªå®šç¾©çš„è‡¨æ™‚è²æ˜</li>\n</ul>\n</li>\n<li>\n<p>Verify Signatureï¼šç™»å…¥æ™‚ä¼ºæœå™¨ç«¯æ‰¾åˆ°å»åˆçš„å¸³æˆ¶å¯†ç¢¼ï¼Œå°±ç”¢ç”Ÿä¸€å€‹èªè­‰ç°½å</p>\n<ul>\n<li>å¯ä»¥æ¯”å° Signature ä¾†ç¢ºèª data æœ‰ç„¡è¢«æ”¹å‹•</li>\n</ul>\n</li>\n<li>é€šå¸¸æœƒç”¢ Access Token å’Œ Refresh Token å…©ç¨® Token (æ­¤æ¬¡ä»‹ç´¹å±¬æ–¼ Access Token)</li>\n<li>\n<p>ç¨å¾®æä¸€ä¸‹</p>\n<ul>\n<li>header åˆç¨± JOSE Header (JSON Object Signing and Encryption)ï¼Œ<a href=\"https://tools.ietf.org/html/rfc7518#section-3.1\" target=\"_blank\" rel=\"nofollow\">JWE</a> å’Œ <a href=\"https://tools.ietf.org/html/rfc7518#section-4.1\" target=\"_blank\" rel=\"nofollow\">JWS</a> é©ç”¨çš„ alg ä¸ç›¸åŒ</li>\n<li>JWE token ä¸åŒæ–¼åˆ†ä¸‰æ®µçš„ JWSï¼ŒJWE æ˜¯åˆ†æˆäº”æ®µï¼šJOSE Headerã€Encrypted Keyã€Initialization Vector(IV)ã€AADã€Ciphertextã€Authentication Tag</li>\n<li>å…¶ä¸­ JOSE Header æ˜¯ä¸‰ç¨® Header è¯é›†è€Œæˆï¼š<br>\nProtected Header + Shared Unprotected Header + Per-Recipient Unprotected Header</li>\n</ul>\n</li>\n</ul>\n<h3>ç”¢ç”Ÿ JWS æµç¨‹</h3>\n<p>header å’Œ payload æ˜¯å¯ä»¥è‡ªè¡Œè¼•æ˜“ decode çš„ (æˆ–ç›´æ¥è²¼<a href=\"https://jwt.io/\" target=\"_blank\" rel=\"nofollow\">å®˜ç¶²</a>è§£) ï¼Œä¸æ‡‰æ”¾ä»»ä½•æ•æ„Ÿè³‡è¨Š</p>\n<ol>\n<li>\n<p>è®€å– header ä¸­çš„åŠ å¯†æ¼”ç®—æ³• (<code>alg</code>: å¿…è¦) ä¾‹å¦‚ HMACã€SHA256ã€RSAã€none</p>\n<ul>\n<li>åˆ—æ¶ˆæ¯èªè­‰ç¢¼ Hash-based Message Authentication Code (HMAC)<br>\nä¸€ç¨®é‡‘é‘°å¼é›œæ¹Šæ¼”ç®—æ³•ï¼Œå¯ä»¥çµåˆåŠ å¯†é‡‘é‘° (key) é€²è¡ŒåŠ å¯†æœ€å¾Œè¼¸å‡º 64 å­—å…ƒçš„å…§å®¹ï¼Œé‡å°å„ç¨®å“ˆå¸Œç®—æ³•éƒ½é€šç”¨ (MD5, SHA-1, SHA-256...)</li>\n<li>HS256 (HMAC with SHA-256)</li>\n<li><code>alg: none</code> æ™‚ JWT å°‡ä¸ç”¨ç”¢ç”Ÿ Signatureï¼Œå°±æœ‰æ©Ÿæœƒè¢«æ”»æ“Šä¾†ç¹é Token çš„ä¾†æºé©—è­‰</li>\n</ul>\n</li>\n<li>å»ºç«‹å°šæœªç°½åçš„ä»¤ç‰Œ<br>\nå°‡ header èˆ‡ payload å„è‡ªé€²è¡Œ base64 ç·¨ç¢¼ä¸¦ä¸”ä»¥<code>.</code>é€£çµå¾—åˆ°</li>\n<li>å–å¾—ç°½åä»¤ç‰Œ signature<br>\nåˆ©ç”¨ç§é‘° key å°å°šæœªç°½åçš„ä»¤ç‰Œé€²è¡ŒåŠ å¯†ç°½åå¾—åˆ°<br>\nâš ï¸ çµ•å°è¦ä¿ç®¡å¥½ keyï¼Œä¸ç„¶èª°éƒ½å¯ä»¥è‡ªè¡Œç”¢ç”Ÿ JWT</li>\n<li>å°‡ 2. èˆ‡ base64 ç·¨ç¢¼å¾Œçš„ 3. çµæœä»¥<code>.</code>é€£çµï¼Œå³ç‚º JWT token<br>\n<img src=\"https://i.imgur.com/oMQboKh.png\"></li>\n</ol>\n<h3>å¯¦ä½œï¼šExpress app ä¸­å¯ä»¥é€é <a href=\"https://www.npmjs.com/package/jsonwebtoken\" target=\"_blank\" rel=\"nofollow\"><code>jsonwebtoken</code></a> ç”¢ç”ŸåŠé©—è­‰ JWT(JWS)</h3>\n<ul>\n<li><code>npm i jsonwebtoken</code></li>\n<li>\n<p>ç°½ç™¼ token<br>\næ™‚æ©Ÿï¼šé€šå¸¸æœƒåœ¨ä½¿ç”¨è€…è¨»å†Šã€ç™»å…¥ã€æ›´æ–°å¯†ç¢¼æ™‚ç”¢ç”Ÿæˆ–æ›´æ–° JWT Token ä¾†åšèº«ä»½èªè­‰ (ps. ç”¨æˆ¶è¢«ç§»é™¤æ™‚ä¹Ÿè©²è®“ Token å¤±æ•ˆ)<br>\n<code>jwt.sign(payload, secretOrPrivateKey, [options, callback])</code></p>\n<ul>\n<li>options çš„ algorithm é è¨­ç‚º HS256</li>\n<li>Ex. ç°½ç™¼ä¸€å€‹ä¸€å°æ™‚å¾ŒéæœŸçš„ JWT token (å¤šç¨®å¯«æ³•æ²’æœ‰ä¸€å®š)</li>\n</ul>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">import jwt from &#39;jsonwebtoken&#39;;\n\n// 1.\njwt.sign(\n  {\n    exp: Math.floor(Date.now() / 1000) + 60 * 60,\n    data: &#39;foobar&#39;,\n  },\n  &#39;secret&#39;\n);\n\n// 2.\njwt.sign(\n  {\n    data: &#39;foobar&#39;,\n  },\n  &#39;secret&#39;,\n  { expiresIn: 60 * 60 }\n);\n\n// 3. æœ€å¥½æ‡‚ ğŸ‘\njwt.sign(\n  {\n    data: &#39;foobar&#39;,\n  },\n  &#39;secret&#39;,\n  { expiresIn: &#39;1h&#39; }\n);</code>\n        </deckgo-highlight-code>\n<p>å¯¦éš›å¯èƒ½å°è£æˆåƒ signToken function æ¯æ¬¡ç°½ç™¼æ™‚ä½¿ç”¨</p>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">import jwt from &#39;jsonwebtoken&#39;;\n\nconst signToken = (id) =&gt; {\n  return jwt.sign({ id }, process.env.JWT_SECRET, {\n    expiresIn: process.env.JWT_EXPIRES_IN,\n  });\n};</code>\n        </deckgo-highlight-code>\n</li>\n<li>\n<p>èªè­‰ Token<br>\nè‹¥ä¼ºæœå™¨ç«¯åœ¨è«‹æ±‚ä¸­æ²’æœ‰æ‰¾åˆ° Tokenï¼Œå›å‚³éŒ¯èª¤ (401 Unauthorized)ï¼›è‹¥æœ‰æ‰¾åˆ° Token å‰‡é©—è­‰å¾Œå†åŸ·è¡Œæ“ä½œ\n<code>jwt.verify(token, secretOrPublicKey, [options, callback])</code></p>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">import { promisify } from &#39;util&#39;;\nimport jwt from &#39;jsonwebtoken&#39;;\n// ...\nconst decoded = await jwt.verify(token, process.env.JWT_SECRET);\n// decoded.id</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code json  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">// decoded\n{ &quot;id&quot;: &quot;5ee38288007f218942c9bd1b&quot;, &quot;iat&quot;: 1592380082, &quot;exp&quot;: 1600156082 }</code>\n        </deckgo-highlight-code>\n</li>\n<li>\n<p>åªèªä»¤ç‰Œä¸èªäººï¼Œåªèƒ½<strong>ç›¡é‡</strong>ç¢ºä¿ key ä¸æœƒè¢«ç›œå–</p>\n<ul>\n<li>æœ€å¥½ä¸è¦å°‡ token å­˜åœ¨ localStorage (å®¹æ˜“è¢« XSS æ”»æ“Šç«Šå–)</li>\n<li>åªåœ¨ HTTPS å®‰å…¨å”å®šä¸‹å‚³é</li>\n<li>Cookie è¨­å®š flag <code>httpOnly</code> (ç„¡æ³•è¢« JavaScript å­˜å–), <code>secure</code> (åªåœ¨ HTTPS å‚³é)</li>\n<li>è¨­ç½® token éæœŸæ™‚é–“... etc.</li>\n<li>Ex. å¦‚è¨»å†Šå’Œç™»å…¥æ™‚å»ç”¢ç”Ÿæ–°çš„ JWT token ä¸¦é€éç›¡é‡å®‰å…¨çš„æ–¹å¼é€çµ¦ client (client ç²å¾—ä»¤ç‰Œç²å¾—æˆæ¬Š)</li>\n<li>\n<p>Client ä¹‹å¾Œå†å°‡æ­¤ä»¤ç‰Œ (JWT) è¨­ç½®åœ¨ Header Authorization å»è¦æ±‚ APIï¼ŒServer å†ä¾æ­¤åšèªè­‰ï¼ŒæˆåŠŸçš„è©±è¿”å›è³‡æ–™</p>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">const createSendToken = (user, statusCode, res) =&gt; {\nconst token = signToken(user._id);\nconst cookieOptions = {\n  expires: new Date(Date.now() + process.env.JWT_COOKIE_EXPIRES_IN * 24 * 60 * 60 * 1000),\n  httpOnly: true, // cookie ç„¡æ³•ç”¨ JavaScript è®€å–ä½†ä»å¯ä»¥åœ¨ HTTP requests å›å‚³çµ¦ server\n};\n\nif (process.env.NODE_ENV === &#39;production&#39;) cookieOptions.secure = true; // é™ HTTPS\n\nres.cookie(&#39;jwt&#39;, token, cookieOptions);\n\ndelete user.password;\n\nres.status(statusCode).json({\n  status: &#39;success&#39;,\n  token,\n  data: {\n    user,\n  },\n});\n};</code>\n        </deckgo-highlight-code>\n</li>\n<li>\n<p>åœ¨æŸäº›éœ€æˆæ¬Š(èªè­‰é€šé)æ‰èƒ½æ“ä½œçš„ API route å‰åŠ ä¸€å±¤ Middleware (è¦ return <code>next()</code>)</p>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">router.patch(&#39;/updateMe&#39;, authController.protect, userController.updateMe);\nrouter.delete(&#39;/deleteMe&#39;, authController.protect, userController.deleteMe);</code>\n        </deckgo-highlight-code>\n<p>æª¢æŸ¥èªè­‰ï¼šé æœŸ Client ç™¼çš„ request Headers Authorization æœƒä»£ä¸Šåˆæ³• Token &#x26; ...</p>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">// éœ€è¦æˆæ¬Šçš„ API å…ˆç¶“éæ­¤åš JWT token èªè­‰ (ä½œç‚º protected route middleware)\nconst protect = catchAsync(async (req, res, next) =&gt; {\nlet token;\nif (req.headers.authorization &amp;&amp; req.headers.authorization.startsWith(&#39;Bearer&#39;)) {\n  token = req.headers.authorization.split(&#39; &#39;)[1];\n}\n\nif (!token) {\n  return next(new AppError(&#39;èªè­‰å·²å¤±æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥&#39;, 401));\n}\n\n// èªè­‰ JWT (token key è¦æ­£ç¢ºæ‰é) å–å› payload (å¯ä»¥æª¢æŸ¥ JWT æˆæ¬Šè€…èº«ä»½æˆ–è³‡æ–™æœ‰ç„¡è®Šé€ )\nconst decoded = await jwt.verify(token, process.env.JWT_SECRET);\n\nconst currentUser = await User.findById(decoded.id);\nif (!currentUser) {\n  return next(new AppError(&#39;æ“æœ‰æ­¤èªè­‰çš„ä½¿ç”¨è€…å·²ä¸å­˜åœ¨&#39;, 401));\n}\n\n// æª¢æŸ¥ token ç°½ç™¼æ™‚é–“æ˜¯å¦åœ¨è®Šæ›´å¯†ç¢¼æ™‚é–“ä¹‹å¾Œï¼Œæ˜¯çš„è©±æ‡‰é‡æ–°ç™»å…¥å–å¾—æ–°èªè­‰\nif (currentUser.changedPasswordAfter(decoded.iat)) {\n  return next(new AppError(&#39;ä½¿ç”¨è€…æœ€è¿‘è®Šæ›´å¯†ç¢¼ï¼Œè«‹é‡æ–°ç™»å…¥&#39;, 401));\n}\n\n// ä¸Šè¿°æª¢æŸ¥æ²’å•é¡Œæ‰çœŸæ­£åŸ·è¡Œ API æŸ¥è©¢æ“ä½œ (é †ä¾¿å‚³é JWT çš„ user)\nreq.user = currentUser;\nnext();\n});</code>\n        </deckgo-highlight-code>\n</li>\n</ul>\n</li>\n</ul>\n<h2>å¯†ç¢¼åš Bcrypt åŠ å¯†è™•ç†å†å„²å­˜</h2>\n<ul>\n<li>\n<p>Bcrypt ç°¡ä»‹</p>\n<ul>\n<li>å…¶å¯¦ä¸æ˜¯åŠ å¯†æ¼”ç®—æ³•ï¼Œè€Œæ˜¯æ…¢é›œæ¹Šæ¼”ç®—æ³• (å’Œ SHA1 ä¸€æ¨£æ˜¯ç¨®é›œæ¹Šæ¼”ç®—æ³•)</li>\n<li>æŠŠå„å€‹æ¬„ä½/å­—å…ƒä¸Ÿé€²å»æŸå€‹å…¬å¼è¨ˆç®—çš„æ–¹å¼å°±å«åšé›œæ¹Š (Hash)ï¼Œé€™å€‹è¨ˆç®—å…¬å¼å°±ç¨±ç‚ºé›œæ¹Šå‡½æ•¸ (Hash function)ï¼Œéç¨‹æ˜¯<strong>ä¸å¯é€†</strong>çš„</li>\n<li>Bcrypt å¯ä»¥é€éè¨­å®šç–Šä»£æ¬¡æ•¸è®“ä»–è®Šæ…¢ (è¿­ä»£æ¬¡æ•¸æ¯å¢åŠ  1 éœ€è¦çš„æ™‚é–“å°±è®Šå…©å€)</li>\n<li>å¯†ç¢¼è¢«ç ´è§£çš„é¢¨éšªæ¯” MD5ã€SHA1 ä½ (ä¾‹ä»¥ç–Šä»£äº”æ¬¡çš„ Bcrypt è¨ˆç®—é€Ÿåº¦å¤§æ¦‚æ¯” SHA1 æ…¢ 1000 å€)</li>\n<li>èƒ½å¤ å°‡ä¸€å€‹å­—ä¸²<strong>åŠ é¹½å¾Œé›œæ¹Š</strong>åŠ å¯†ï¼Œåœ¨è¦åŠ å¯†çš„å­—ä¸²ä¸­åŠ ç‰¹å®šçš„å­—ç¬¦ã€æ‰“äº‚åŸå§‹çš„å­—ç¬¦ä¸²ï¼Œä½¿å…¶ç”Ÿæˆçš„æ•£åˆ—çµæœç”¢ç”Ÿè®ŠåŒ–ï¼ŒåŠ é¹½æ¬¡æ•¸å¤šè¶Šå®‰å…¨ï¼Œä½†åŠ å¯†æ™‚é–“ä¹Ÿå°±è¶Šé•·<br>\nåŠ å¯†å¾Œçš„ bcrypt åˆ†ç‚ºå››å€‹éƒ¨åˆ†<br>\n<img src=\"https://i.imgur.com/Wp3VHdi.png\"></li>\n<li>Bcryptï¼šè©²å­—ä¸²ç‚º UTF-8 ç·¨ç¢¼ï¼Œä¸¦ä¸”åŒ…å«ä¸€å€‹çµ‚æ­¢ç¬¦</li>\n<li>Round å›åˆæ•¸ï¼šæ¯å¢åŠ ä¸€æ¬¡å°±åŠ å€é›œæ¹Šæ¬¡æ•¸ï¼Œé è¨­ 10 æ¬¡</li>\n<li>Salt åŠ é¹½ï¼š128 bits 22 å€‹å­—å…ƒ</li>\n<li>Hash é›œæ¹Šï¼š138 bits 31 å€‹å­—å…ƒ</li>\n<li>é˜²æ­¢ rainbow table attacks</li>\n<li>Rainbow table æ˜¯ä¸€å€‹ç”±å¤§é‡ç´”æ–‡æœ¬å¯†ç¢¼å’Œèˆ‡æ¯å€‹å¯†ç¢¼ç›¸å°æ‡‰çš„ hash çµ„æˆçš„åº«</li>\n<li><a href=\"https://md5hashing.net/\" target=\"_blank\" rel=\"nofollow\">Ultimate Hashing and Anonymity toolkit</a> å¯è¼•æ˜“ç ´è§£é•·åº¦çŸ­ç°¡æ˜“çš„é›œæ¹ŠåŸæ–‡</li>\n</ul>\n</li>\n<li><a href=\"https://www.npmjs.com/package/bcryptjs\" target=\"_blank\" rel=\"nofollow\"><code>npm i bcryptjs</code></a></li>\n<li>\n<p><a href=\"https://www.npmjs.com/package/bcryptjs#hashs-salt-callback-progresscallback\" target=\"_blank\" rel=\"nofollow\"><code>hash(s, salt, callback, progressCallback=)</code></a><br>\nåœ¨ mongoose æœ‰ password field çš„ Schema ä¸Šåš save document å‰çš„ middleware ä¾†è™•ç†æ˜æ–‡å¯†ç¢¼ç¯„ä¾‹</p>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">userSchema.pre(&#39;save&#39;, async function(next) {\nif (!this.isModified(&#39;password&#39;)) return next(); // åªæœ‰åœ¨ password ä¿®æ”¹æ™‚æ‰åŸ·è¡Œ\n\nthis.password = await bcrypt.hash(this.password, 12); // ç”¨é•·åº¦12çš„saltå»hash\nthis.passwordConfirm = undefined;\nthis.passwordChangedAt = Date.now() - 1000;\nnext();\n});</code>\n        </deckgo-highlight-code>\n</li>\n<li>\n<p>è£œå……ä¸€é»åŠ å¯†æ¼”ç®—æ³•ï¼Œå¦‚ï¼š</p>\n<ul>\n<li>å°ç¨±åŠ å¯†æ¼”ç®—æ³•</li>\n<li>åŠ å¯†è§£å¯†éƒ½ç”¨åŒä¸€å€‹ keyï¼Œå¿«ä¸”å®‰å…¨</li>\n<li>\n<p>ä¾‹</p>\n<ul>\n<li>AES (Advanced Encryption Standard)</li>\n<li>DES (Data Encryption Standard)ã€3DES (Triple DES)</li>\n<li>é€Ÿåº¦ï¼šAES > 3DES > DES</li>\n<li>è½èªªç¾åœ‹æ”¿åºœæ©Ÿå¯†æª”æ¡ˆä¹Ÿç”¨ AES åŠ å¯†(?)</li>\n</ul>\n</li>\n<li>éå°ç¨±åŠ å¯†æ¼”ç®—æ³•</li>\n<li>æœƒç”¢ç”Ÿä¸€çµ„å…©å€‹ Keyï¼šå…¬é‘°è·Ÿç§é‘°</li>\n<li>ç§é‘°å¯ä»¥ç”¢å‡ºå…¬é‘°ã€å…¬é‘°ç„¡æ³•ç”¢å‡ºç§é‘°</li>\n<li>å…©æŠŠé‘°åŒ™åœ¨åŠ å¯†ã€è§£å¯†ä¸Šå½¼æ­¤å¯é€šç”¨ï¼šå…¬é‘°åŠ å¯†ã€ç§é‘°è§£å¯†ï¼Œæˆ–æ˜¯ç§é‘°åŠ å¯†ã€å…¬é‘°è§£å¯† (HTTPS çš„ SSL æ•¸ä½ç°½ç« å°±æ˜¯æ­¤æ‡‰ç”¨)</li>\n<li>ä¾‹\n_ RSAã€DSA (Digital Signature Algorithm)ã€ECC (Elliptic Curves Cryptography)\n_ é€Ÿåº¦ï¼šECC > RSA, DSA\n<img src=\"https://i.imgur.com/m2s3GgW.png\"></li>\n</ul>\n</li>\n</ul>\n<h2>è¨‚å®š Role ä¾†é™åˆ¶æ¬Šé™</h2>\n<ul>\n<li>ä¾‹å¦‚ User Model ä¸­çš„ Schema å®šç¾©ä¸€ enum å‹åˆ¥çš„ roleï¼Œä¹‹å¾Œä¾æ­¤åšæ¬Šé™ä¾æ“š</li>\n<li>\n<p>æŸäº›éœ€æª¢æŸ¥ä½¿ç”¨è€…æ¬Šé™æ‰èƒ½æ“ä½œçš„ API routeï¼Œå¯åœ¨æ“ä½œå‰åŠ ä¸€å±¤æª¢æŸ¥ user æ¬Šé™çš„ middleware</p>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">router\n.route(&#39;/:id&#39;)\n.get(tourController.getTour)\n.patch(tourController.updateTour)\n.delete(authController.protect, authController.restrictTo(&#39;admin&#39;, &#39;lead-guide&#39;), tourController.deleteTour);</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">const restrictTo = (...roles) =&gt; {\nreturn (req, res, next) =&gt; {\n  if (!roles.includes(req.user.role)) {\n    return next(new AppError(&#39;æ‚¨æ²’æœ‰æ­¤æ“ä½œæ¬Šé™&#39;, 403));\n  }\n\n  next();\n};\n};</code>\n        </deckgo-highlight-code>\n</li>\n</ul>\n<h2>ä¸€äº›è·Ÿå®‰å…¨æ€§ç›¸é—œçš„ Middleware library</h2>\n<blockquote>\n<p>Express mongoose restful api å¯¦ä½œç”¨åˆ°</p>\n</blockquote>\n<ul>\n<li>\n<p><a href=\"https://www.npmjs.com/package/helmet\" target=\"_blank\" rel=\"nofollow\"><code>npm i helmet</code></a></p>\n<ul>\n<li>A collection of 12 smaller middleware functions that set HTTP response headers.\nExpress app ä¸­çš„å®‰å…¨æœ€ä½³åšæ³•ï¼Œæœƒé©ç•¶è¨­å®š HTTP æ¨™é ­ï¼Œæœ‰åŠ©æ–¼é˜²ç¯„æ‡‰ç”¨ç¨‹å¼å‡ºç¾å·²çŸ¥çš„ Web æ¼æ´</li>\n<li>\n<p>æ‡‰æ”¾åœ¨æœ€ä¸€é–‹å§‹è¨­å®š</p>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">app.use(helmet());</code>\n        </deckgo-highlight-code>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"https://www.npmjs.com/package/express-rate-limit\" target=\"_blank\" rel=\"nofollow\"><code>npm i express-rate-limit</code></a></p>\n<ul>\n<li>é™åˆ¶ä¾†è‡ªåŒä¸€ IP çš„é‡è¤‡è«‹æ±‚</li>\n<li>å¯é˜²æ­¢ DDoS</li>\n</ul>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">import rateLimit from &#39;express-rate-limit&#39;;\n\nconst limiter = rateLimit({\n  max: 100,\n  windowMs: 60 * 60 * 1000,\n  message: &#39;æ­¤IPè«‹æ±‚å¤ªå¤šæ¬¡äº†ï¼è«‹ä¸€å°æ™‚å¾Œå†è©¦ï¼&#39;,\n});\napp.use(&#39;/api&#39;, limiter);</code>\n        </deckgo-highlight-code>\n</li>\n<li>\n<p><a href=\"https://www.npmjs.com/package/express-mongo-sanitize\" target=\"_blank\" rel=\"nofollow\"><code>npm i express-mongo-sanitize</code></a></p>\n<ul>\n<li>\n<p>Data sanitization é˜²æ­¢ NoSQL query injectionï¼Œé€™é‚Šä¸»è¦é‡å° MongoDB çš„ä¿ç•™å­—å¦‚ <code>$</code>, <code>.</code>ã€‚ä¾‹å¦‚åœ¨æŸå«æœ‰ find email æ“ä½œçš„ api ä¸­ request body ä»£ç›¸ç•¶æ–¼ query all çš„å€¼ <code>{ \"email\": {\"$gt\": \"\"} }</code>ï¼Œå°±æœƒè¢«æ“‹ä¸‹ä¾†</p>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">app.use(mongoSanitize());</code>\n        </deckgo-highlight-code>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"https://www.npmjs.com/package/xss-clean\" target=\"_blank\" rel=\"nofollow\"><code>npm i xss-clean</code></a></p>\n<ul>\n<li>\n<p>Data sanitization é˜²æ­¢ XSS æ”»æ“Šï¼Œå¯æ›¿æ› <code>&#x3C;</code> ç‚º <code>&#x26;lt;</code></p>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">app.use(xss());</code>\n        </deckgo-highlight-code>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"https://www.npmjs.com/package/hpp\" target=\"_blank\" rel=\"nofollow\"><code>npm i hpp</code></a></p>\n<ul>\n<li>ç”¨æ–¼é˜²æ­¢ HTTP Parameter Pollution</li>\n<li>ä¾‹å¦‚ç¶²å€å¾Œé¢ä»£çš„ queryString key ç›¸åŒçš„ä¸åªä¸€å€‹æ™‚ï¼Œå®ƒæœƒè‡ªå‹•å–æˆæœ€å¾Œä¸€å€‹ã€å‰é¢éƒ½ç„¡æ•ˆ</li>\n<li>ä½†æ˜¯å¯ä»¥é€éæŠŠç‰¹å®š key åŠ ç™½åå–®è®“å®ƒå¾—ä»¥ä¸è¢«éæ¿¾</li>\n<li>\n<p>æ‡‰è©²åœ¨æœ€å¾Œè¨­å®š</p>\n<deckgo-highlight-code javascript\\  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">app.use(\nhpp({\nwhitelist: [&#39;age&#39;, &#39;team&#39;]\n});\n);</code>\n        </deckgo-highlight-code>\n</li>\n</ul>\n</li>\n</ul>\n<h2>é‡è¨­å¯†ç¢¼æ©Ÿåˆ¶</h2>\n<p>åˆ©ç”¨è³¦äºˆè«‹æ±‚é‡è¨­å¯†ç¢¼ç”¨æˆ¶è€… éš¨æ©Ÿ resetToken èˆ‡ Token éæœŸæ™‚é–“å„²å­˜é€² DB (åŒæ™‚å¯„ä¿¡)ï¼Œä¸¦åœ¨æ›´æ–°å¯†ç¢¼æ™‚å¯¦ä½œä¸­ç”¨ä¾†é©—è­‰ä¸¦é€é Token æŸ¥å› User åšæ›´æ–°</p>\n<ul>\n<li><a href=\"https://www.npmjs.com/package/nodemailer\" target=\"_blank\" rel=\"nofollow\"><code>npm i nodemailer</code></a></li>\n<li>é–‹ç™¼éšæ®µæ²’æœ‰ Mail Server å¯ä»¥ä½¿ç”¨ <a href=\"https://mailtrap.io/\" target=\"_blank\" rel=\"nofollow\">MailTrap</a> æ¸¬è©¦å¯„æ”¶ä¿¡<br>\n<img src=\"https://i.imgur.com/yBu0U7l.png\"></li>\n<li>\n<p>åˆ©ç”¨ Node.js çš„å…§å»ºæ¨¡çµ„ crypto ä¾†ç°¡å–®åŠ å¯†è™•ç†è³‡æ–™ï¼Œä»¥ä¸‹å¯¦ä½œç¯„ä¾‹</p>\n<ol>\n<li>åœ¨ Model Schema methods å®šç¾©ç”¢ç”Ÿå¯†ç¢¼é‡è¨­ Token ä¸¦è¨­ç½®éæœŸæ™‚é–“å­˜ DB user æ–¹æ³•ï¼šæ³¨æ„æ˜¯ return æœª Hash çš„ Token (è¦ä»£çµ¦ä¿®æ”¹å¯†ç¢¼ API çš„ Token)ï¼Œä½†å„²å­˜çš„æ˜¯æœ‰åœ¨ç¶“é hash è™•ç†å¾Œçš„ Token</li>\n</ol>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">// é€é node å…§å»º crypto å®‰å…¨çš„äº‚æ•¸ç”¢ç”Ÿå¯†ç¢¼é‡è¨­ tokenï¼Œä¸¦è¨­ç½®éæœŸæ™‚é–“\nuserSchema.methods.createPasswordResetToken = function() {\n  const resetToken = crypto.randomBytes(32).toString(&#39;hex&#39;);\n\n  this.passwordResetToken = crypto\n    .createHash(&#39;sha256&#39;) // å‰µå»ºsha256 hashå¯¦ä¾‹\n    .update(resetToken) // update()å°‡å­—ç¬¦ä¸²ç›¸åŠ \n    .digest(&#39;hex&#39;); // digest()å°‡å­—ç¬¦ä¸²hashè¿”å›\n\n  this.passwordResetExpires = Date.now() + 10 * 60 * 1000; // 10 mins å¾ŒéæœŸ\n\n  return resetToken;\n};</code>\n        </deckgo-highlight-code>\n<ol start=\"2\">\n<li>å¿˜è¨˜å¯†ç¢¼ API æŸ¥è©¢ email çš„ User å­˜åœ¨ç”¨å°å®ƒè³¦äºˆé‡è¨­å¯†ç¢¼ Token å’ŒéæœŸæ™‚é–“å„²å­˜ï¼›ä¸å­˜åœ¨å†æ¸…æ‰é‡è¨­ç›¸é—œæ¬„ä½ï¼ŒåŒæ™‚å¯„å‡ºä»£æœ‰è©² Token çš„é‡è¨­å¯†ç¢¼ API çµ¦ User</li>\n</ol>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">const forgotPassword = catchAsync(async (req, res, next) =&gt; {\n  const user = await User.findOne({ email: req.body.email });\n  if (!user) {\n    return next(new AppError(&#39;æŸ¥ç„¡æ­¤ email ä½¿ç”¨è€…&#39;, 404));\n  }\n\n  // ç”¢ç”Ÿ reset ç”¨çš„éš¨æ©Ÿ token(Model schema methods å…ˆå®šç¾©å¥½)\n  const resetToken = user.createPasswordResetToken();\n  await user.save({ validateBeforeSave: false });\n\n  // è¨­å®šå¯„ä¿¡å…§å®¹\n  const resetURL = `${req.protocol}://${req.get(&#39;host&#39;)}/api/v1/users/resetPassword/${resetToken}`;\n  const message = `å¿˜è¨˜å¯†ç¢¼ï¼Ÿè«‹ç”¨ PATCH è¨­ç½® password å’Œ passwordConfirm è«‹æ±‚ API: ${resetURL}.\\nå¦‚æœæ‚¨ç„¡å¿˜è¨˜å¯†ç¢¼ï¼Œè«‹ç„¡è¦–æ­¤è¨Šæ¯ã€‚`;\n\n  try {\n    await sendEmail({\n      email: user.email,\n      subject: &#39;å¯†ç¢¼é‡è¨­ (10åˆ†é˜å¾ŒéæœŸ)&#39;,\n      message,\n    });\n\n    res.status(200).json({\n      status: &#39;success&#39;,\n      message: &#39;é‡è¨­å¯†ç¢¼ Token å·²å¯„å‡ºï¼&#39;,\n    });\n  } catch (err) {\n    user.passwordResetToken = undefined;\n    user.passwordResetExpires = undefined;\n    await user.save({ validateBeforeSave: false });\n\n    return next(new AppError(&#39;å¯„ä¿¡ç™¼ç”ŸéŒ¯èª¤ï¼&#39;), 500);\n  }\n});</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">import nodemailer from &#39;nodemailer&#39;;\n\nexport const sendEmail = async (options) =&gt; {\n  // 1) Create a transporter\n  const transporter = nodemailer.createTransport({\n    host: process.env.EMAIL_HOST,\n    port: process.env.EMAIL_PORT,\n    auth: {\n      user: process.env.EMAIL_USERNAME,\n      pass: process.env.EMAIL_PASSWORD,\n    },\n  });\n\n  // 2) Define the email options\n  const mailOptions = {\n    from: &#39;ç™¾é˜œäººè³‡ç³»çµ± &lt;baifu.hr@baifu-tech.net&gt;&#39;,\n    to: options.email,\n    subject: options.subject,\n    text: options.message,\n    // html:\n  };\n\n  // 3) Actually send the email\n  await transporter.sendMail(mailOptions);\n};</code>\n        </deckgo-highlight-code>\n<ol start=\"3\">\n<li>å¾—åˆ°é‡è¨­å¯†ç¢¼çš„ API é©—è­‰ Token å’Œæ˜¯å¦æœ‰æ•ˆå¾Œå†ä¾ Token æŸ¥å› Userï¼Œå°å®ƒåšå¯†ç¢¼æ›´æ–°</li>\n</ol>\n<deckgo-highlight-code javascript  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">const resetPassword = catchAsync(async (req, res, next) =&gt; {\n  // hashed resetToken and compare document&#39;s hashed resetToken passwordResetToken\n  const hashedToken = crypto\n    .createHash(&#39;sha256&#39;)\n    .update(req.params.token)\n    .digest(&#39;hex&#39;);\n\n  const user = await User.findOne({\n    passwordResetToken: hashedToken,\n    passwordResetExpires: { $gt: Date.now() },\n  });\n\n  // æª¢æŸ¥ token æœªéæœŸä¸”ä½¿ç”¨è€…å­˜åœ¨\n  if (!user) {\n    return next(new AppError(&#39;Token ç„¡æ•ˆæˆ–æ˜¯å·²éæœŸ&#39;, 400));\n  }\n  user.password = req.body.password;\n  user.passwordConfirm = req.body.passwordConfirm;\n  user.passwordResetToken = undefined;\n  user.passwordResetExpires = undefined;\n  await user.save(); // ä¸€æ¨£æœƒç¶“é middleware åšå¯†ç¢¼ hash ä¸¦ä¿®æ”¹ passwordChangedAt\n\n  // ä½¿ç”¨è€…ç”¢ç”Ÿæ–° token å›å‚³(ç™»å…¥)\n  createSendToken(user, 200, res);\n});</code>\n        </deckgo-highlight-code>\n</li>\n</ul>\n<h2>CSRF</h2>\n<p>å› ç‚ºç€è¦½å™¨çš„æ©Ÿåˆ¶ï¼Œä½ åªè¦ç™¼é€ request çµ¦æŸå€‹ç¶²åŸŸï¼Œå°±æœƒæŠŠé—œè¯çš„ cookie ä¸€èµ·å¸¶ä¸Šå»ã€‚å¦‚æœä½¿ç”¨è€…æ˜¯ç™»å…¥ç‹€æ…‹ï¼Œé‚£é€™å€‹ request å°±ç†æ‰€ç•¶ç„¶åŒ…å«äº†ä»–çš„è³‡è¨Šï¼ˆä¾‹å¦‚èªª session idï¼‰ï¼Œé€™ request çœ‹èµ·ä¾†å°±åƒæ˜¯ä½¿ç”¨è€…æœ¬äººç™¼å‡ºçš„ã€‚<br>\nåˆç¨± One-Click Attackï¼Œä½†å…¶å¯¦ç”šè‡³ä¸éœ€è¦ click è€Œä¸”ä¸æœƒè¢«å¯Ÿè¦º(æ²’æœ‰ redirect)<br>\nä¾‹å¦‚</p>\n<deckgo-highlight-code html  terminal=\"carbon\" theme=\"monokai\" line-numbers=\"true\"  highlight-lines=\"\">\n          <code slot=\"code\">&lt;iframe style=&quot;display:none&quot; name=&quot;csrf-frame&quot;&gt;&lt;/iframe&gt;\n&lt;form method=&quot;POST&quot; action=&quot;https://small-min.blog.com/delete&quot; target=&quot;csrf-frame&quot; id=&quot;csrf-form&quot;&gt;\n  &lt;input type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;3&quot; /&gt;\n  &lt;input type=&quot;submit&quot; value=&quot;submit&quot; /&gt;\n&lt;/form&gt;\n&lt;script&gt;\n  document.getElementById(&#39;csrf-form&#39;).submit();\n&lt;/script&gt;</code>\n        </deckgo-highlight-code>\n<blockquote>\n<p>æ‰€ä»¥è¨˜å¾—æ¯æ¬¡ä½¿ç”¨å®Œç¶²ç«™å°±ç™»å‡ºï¼Œå°±å¯ä»¥é¿å…æ‰ CSRF</p>\n</blockquote>\n<h3>Server é˜²ç¯„</h3>\n<ol>\n<li>æª¢æŸ¥ Referer (request å¾å“ªä¾†)ï¼Œä½†æœ‰çš„ç€è¦½å™¨ä¸æœƒå¸¶ï¼Œæˆ–æ˜¯è¢«é—œæ‰</li>\n<li>åŠ ä¸Šåœ–å½¢é©—è­‰ç¢¼ã€ç°¡è¨Šé©—è­‰ç¢¼ ...</li>\n<li>ç”¢ç”Ÿéš¨æ©Ÿçš„ CSRF Token å­˜åœ¨ Server Sessionï¼Œä¸¦æ ¸å°è«‹æ±‚è€…å¸¶çš„ Session æ˜¯å¦ä¸€æ¨£</li>\n<li>Double Submit Cookieï¼šServer æ¯”å° Cookie å…§çš„ CSRF Token èˆ‡ form è£¡é¢çš„ CSRF Tokenï¼Œæª¢æŸ¥æ˜¯å¦æœ‰å€¼ä¸¦ä¸”ç›¸ç­‰</li>\n</ol>\n<p>ä¸‹æ¬¡å†è£œå…… JWE (JSON Web Encryption)ã€ OAuth 2.0 çš„éƒ¨åˆ†</p>\n<h2>Reference</h2>\n<ul>\n<li><a href=\"https://medium.com/@ryanchenkie_40935/react-authentication-how-to-store-jwt-in-a-cookie-346519310e81\" target=\"_blank\" rel=\"nofollow\">React Authentication: How to Store JWT in a Cookie</a></li>\n<li><a href=\"https://medium.com/mr-efacani-teatime/%E6%B7%BA%E8%AB%87jwt%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7%E8%88%87%E9%81%A9%E7%94%A8%E6%83%85%E5%A2%83-301b5491b60e\" target=\"_blank\" rel=\"nofollow\">æ·ºè«‡ JWT çš„å®‰å…¨æ€§èˆ‡é©ç”¨æƒ…å¢ƒ</a></li>\n<li><a href=\"https://5xruby.tw/posts/what-is-jwt/\" target=\"_blank\" rel=\"nofollow\">æ˜¯èª°åœ¨æ•²æ‰“æˆ‘çª—ï¼Ÿä»€éº¼æ˜¯ JWTï¼Ÿ</a></li>\n<li><a href=\"https://medium.com/starbugs/how-to-store-password-in-database-sefely-6b20f48def92\" target=\"_blank\" rel=\"nofollow\">è½èªªä¸èƒ½ç”¨æ˜æ–‡å­˜å¯†ç¢¼ï¼Œé‚£åˆ°åº•è©²æ€éº¼å­˜ï¼Ÿ</a></li>\n<li><a href=\"https://kknews.cc/zh-tw/code/kbqp4bb.html\" target=\"_blank\" rel=\"nofollow\">åŠ å¯†ç®—æ³•(DES,AES,RSA,MD5,SHA1,Base64)æ¯”è¼ƒå’Œé …ç›®æ‡‰ç”¨</a></li>\n<li><a href=\"http://blog.shaochuancs.com/about-error-capturestacktrace/\" target=\"_blank\" rel=\"nofollow\">é—œæ–¼ Error.captureStackTrace</a></li>\n<li><a href=\"https://mongoosejs.com/docs/api.html\" target=\"_blank\" rel=\"nofollow\">Mongoose API Document</a></li>\n</ul>","timeToRead":15,"frontmatter":{"title":"Express - Authentication, Authorization and Security","date":"30 Jun 2020","tags":["security","express"],"path":"blog/20200630","excerpt":"ç°¡ä»‹ Express RESTful API Server ç¯„ä¾‹ä¸­ JWT æ¬Šé™ã€æˆæ¬Šç›¸é—œã€‚"}},"allMarkdownRemark":{"edges":[{"node":{"frontmatter":{"path":"blog/20210109-3","title":"REST / RESTful & HTTP Methods","tags":["javascript"],"excerpt":"ç°¡æ˜“æ•´ç†ã€‚"}}},{"node":{"frontmatter":{"path":"blog/20210110","title":"Pop Quiz","tags":["javascript"],"excerpt":"è¨˜éŒ„è¸©åˆ°çš„é™·é˜±é¡Œã€‚"}}},{"node":{"frontmatter":{"path":"blog/20210725","title":"åˆè©¦ SonarQube","tags":["tool"],"excerpt":"è¨˜éŒ„ä¸‹èªè­˜çš„æ–°æ±è¥¿ã€‚"}}},{"node":{"frontmatter":{"path":"blog/20210725-2","title":"SVGR è¨­ç½®","tags":["javascript"],"excerpt":"webpack loader ä»¥ Component æ–¹å¼ä½¿ç”¨ Svgã€‚"}}},{"node":{"frontmatter":{"path":"blog/20200910","title":"Apollo Server å…¥é–€ç¯‡","tags":["apollo"],"excerpt":"å¿«é€Ÿè¤‡ç¿’å»å¹´åˆ†äº«çš„ GraphQL Schema å’Œ Client query èªæ³•ï¼Œä¸¦ç°¡ä»‹å¦‚ä½•ä»¥ Apollo Server å»ºç«‹ GraphQL Serverã€‚"}}},{"node":{"frontmatter":{"path":"blog/20200527","title":"å¸¸ç”¨ NoSQL é›²ç«¯è³‡æ–™åº« - Part 2 Firebase","tags":["firebase"],"excerpt":"ç°¡ä»‹ Google æä¾›çš„å¾Œç«¯æœå‹™å¹³è‡ºï¼ˆBaaSï¼‰ä¸­çš„å…©ç¨® DBï¼Œrealtime database å’Œ cloud firestoreã€‚"}}},{"node":{"frontmatter":{"path":"blog/20210109-2","title":"IntersectionObserver","tags":["javascript"],"excerpt":"å…¬å¸å°ˆæ¡ˆæœ‰å€‹æ—¥æœŸé€£å‹•çš„ scroll å„ªåŒ–è©¦é©—ï¼ŒåŸå…ˆæ˜¯ç›£è½ scrollã€‚"}}},{"node":{"frontmatter":{"path":"blog/20210109","title":"Response Set-Cookie ç„¡æ•ˆ","tags":["apollo"],"excerpt":"è¨˜éŒ„å€‹ä¹‹å‰åœ¨å’ŒåŒäº‹å€‘å¼„ Side project æ™‚çŠ¯è ¢é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±ºæ–¹å¼ã€‚"}}},{"node":{"frontmatter":{"path":"blog/20190909","title":"Prisma - Schema, Data Model, Relations, Client","tags":["prisma"],"excerpt":"æœªä¾† Side project å¯èƒ½æœƒæ‡‰ç”¨åˆ°çš„ SDL first é–‹ç™¼æµç¨‹è§’åº¦ï¼Œç°¡ä»‹æ­¤å¯ä»¥å–ä»£å‚³çµ± ORM çš„ DB toolkitã€‚"}}},{"node":{"frontmatter":{"path":"blog/20191107","title":"Javascript Event loop - macro task & micro task","tags":["javascript"],"excerpt":"ä»‹ç´¹ Event loop å®¹æ˜“æ··æ·†çš„ç•°æ­¥ä»»å‹™ macro task & micro taskã€‚"}}},{"node":{"frontmatter":{"path":"blog/20191125","title":"åˆæ¢ RxJSï¼ˆä¸‹ï¼‰","tags":["rxjs"],"excerpt":"ç°¡ä»‹ä¸Šæ¬¡æœªå®Œçš„ RxJS å‰©é¤˜è§’è‰²ï¼Œå’Œä»‹ç´¹ç›®å‰å…¬å¸å¾Œå°å°ˆæ¡ˆä½¿ç”¨çš„ redux-observableã€‚"}}},{"node":{"frontmatter":{"path":"blog/20200518","title":"å¸¸ç”¨ NoSQL é›²ç«¯è³‡æ–™åº« - Part 1 MongoDB","tags":["mongodb"],"excerpt":"ç°¡ä»‹ Relational/NoSQL databaseã€mongoose ORM å¯« mongo CRUD APIã€‚"}}},{"node":{"frontmatter":{"path":"blog/20190907","title":"GraphQL & Apollo Client","tags":["apollo"],"excerpt":"ç°¡å–®ä»‹ç´¹ React Client ç«¯å¦‚ä½•ç”¨ Apollo å° GraphQL Server åšè³‡æ–™å­˜å–æ“ä½œã€‚"}}},{"node":{"frontmatter":{"path":"blog/20190906","title":"åˆæ¢ Storybook","tags":["javascript"],"excerpt":"åˆæ¢é€™æ¬¾èƒ½å¤ åœ¨é–‹ç™¼å‰ç«¯å…ƒä»¶æˆ–æ˜¯å‡½å¼åº«çš„åŒæ™‚ï¼Œå¯ä»¥å¿«é€Ÿåœ°å»ºç«‹å…ƒä»¶å„ç¨®æ“ä½œæ¨¡å¼æˆ–æ˜¯æ¨£å¼çš„å·¥å…·ã€‚"}}},{"node":{"frontmatter":{"path":"blog/20190906-2","title":"React Hooks - useCallback, useMemo, useRef","tags":["reactjs"],"excerpt":"JavaScript æ˜¯å–®åŸ·è¡Œç·’ã€å–®ç·šç¨‹çš„ç¨‹å¼èªè¨€ï¼Œæ‰€æœ‰çš„ç¨‹å¼ç¢¼ç‰‡æ®µéƒ½æœƒåœ¨å †ç–Šä¸­è¢«åŸ·è¡Œï¼ŒWeb worker ç›¸ç•¶æ–¼å¯è®“ä¸»ç·šç¨‹é–‹å…¶ä»– threadã€‚"}}},{"node":{"frontmatter":{"path":"blog/20191017","title":"åˆæ¢ RxJSï¼ˆä¸Šï¼‰","tags":["rxjs"],"excerpt":"ç°¡ä»‹ç›¸é—œçš„è¨­è¨ˆæ¨¡å¼ä¸­çš„ Behavioral Patternï¼Œå†ä»‹ç´¹ RxJSï¼ˆå…ˆè¬› Observableï¼‰"}}},{"node":{"frontmatter":{"path":"blog/20190707","title":"JavaScript HTML5 Web Worker & CRA ä½¿ç”¨è¸©é›·","tags":["javascript"],"excerpt":"JavaScript æ˜¯å–®åŸ·è¡Œç·’ã€å–®ç·šç¨‹çš„ç¨‹å¼èªè¨€ï¼Œæ‰€æœ‰çš„ç¨‹å¼ç¢¼ç‰‡æ®µéƒ½æœƒåœ¨å †ç–Šä¸­è¢«åŸ·è¡Œï¼ŒWeb worker ç›¸ç•¶æ–¼å¯è®“ä¸»ç·šç¨‹é–‹å…¶ä»– threadã€‚"}}},{"node":{"frontmatter":{"path":"blog/20190108","title":"JavaScript èªè­˜éåŒæ­¥ Callback, Promise, async/await","tags":["javascript"],"excerpt":"Asynchronous éåŒæ­¥çš„ä¸åŒå¯«æ³•çš„æ•´ç†ç­†è¨˜ã€‚"}}},{"node":{"frontmatter":{"path":"blog/20170728","title":"WebForm è¨»å†Š JavaScript","tags":["asp.net","javascript"],"excerpt":"å‹•æ…‹ç”¢ç”ŸJSåœ¨ç›®å‰å…¬å¸å°ˆæ¡ˆä¸­æ˜¯æ»¿å¸¸ç”¨åˆ°çš„å°æŠ€å·§ï¼Œä¸åŒçš„ç”¨æ³•æœƒç”¢ç”Ÿåœ¨Web Page çš„ä¸åŒä½ç½®è€Œæœ‰ç›´è­¯å¼èªè¨€çš„å‰å¾Œé †åºå·®ã€‚"}}},{"node":{"frontmatter":{"path":"blog/20170604","title":"Web App æ¨æ’­é€šçŸ¥","tags":["asp.net"],"excerpt":"éš¨è‘—è¡Œå‹•å’Œç©¿è¼‰è£ç½®çš„èˆˆèµ·ï¼Œæ¨æ’­é€šçŸ¥ (Push Notification) æˆç‚ºç¶­ç¹«Appç”¨æˆ¶é—œä¿‚ç›¸ç•¶æœ‰åŠ›çš„å·¥å…·"}}},{"node":{"frontmatter":{"path":"blog/20180514","title":"JavaScript ä¸­ this æŒ‡å‘","tags":["javascript"],"excerpt":"ç°¡ä»‹ this æŒ‡å‘çš„å…­ç¨®æƒ…æ³ã€‚"}}},{"node":{"frontmatter":{"path":"blog/20180521","title":"Web å¸¸è¦‹æ”»æ“Šæ‰‹æ³•","tags":["security"],"excerpt":"æ“æœ‰åŸºæœ¬çš„è³‡å®‰è§€å¿µä¿è­·å¥½è‡ªå®¶è³‡æ–™å’Œ user ä½¿ç”¨ç’°å¢ƒæ˜¯é–‹ç™¼äººå“¡é‡è¦çš„ä¸€é»ã€‚"}}},{"node":{"frontmatter":{"path":"blog/20170421","title":"å­˜å–é ç«¯ EventLog","tags":["asp.net","javascript"],"excerpt":"åœ¨å…¬å¸ä¸­å¯¦ä½œä¸€å€‹ Event log çš„æŸ¥è©¢å·¥å…·ã€‚ï¼ˆä¹‹å¾Œä¾†å¯«äº† D3 å‘ˆç¾æŸ¥è©¢ç•°å¸¸æŸ¥è©¢çš„éƒ¨åˆ†ï¼‰"}}},{"node":{"frontmatter":{"path":"blog/20170714","title":"WebForm ä½¿ç”¨ reCAPTCHA é©—è­‰","tags":["asp.net"],"excerpt":"é€™å€‹æˆ‘ä¸æ˜¯æ©Ÿå™¨äººé©—è­‰ä¸€å®šä¸é™Œç”Ÿï¼Œæ»¿å¤šç™»å…¥ç•«é¢æœƒçœ‹åˆ°çš„ï¼Œå‰›å¥½ä»Šå¤©æ¥åˆ°æŠŠåœ–å½¢é©—è­‰æ”¹ç‚º reCAPTCHA å°±é †æ‰‹è¨˜ä¸‹ã€‚"}}},{"node":{"frontmatter":{"path":"blog/20170508","title":"WebForm åœ–ç‰‡ä¸Šå‚³æª¢æŸ¥","tags":["asp.net"],"excerpt":"é–‹æ”¾ä¸Šå‚³æœ‰å¯èƒ½è¢«å‚³å¥‡æ€ªæ±è¥¿çš„é¢¨éšªï¼Œåªæª¢æŸ¥æ‰€çœ‹åˆ°çš„å‰¯æª”åï¼Œè¬¹æ…ä¾†èªªä¼¼ä¹æ˜¯ä¸å¤ çš„ã€‚"}}}]}},"pageContext":{"postPath":"blog/20200630","translations":[{"hreflang":"en","path":"/blog/20200630"}]}},"staticQueryHashes":["4097791827"]}